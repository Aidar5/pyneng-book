Количество потоков
------------------

Сколько потоков нужно использовать при подключении к оборудованию?
На этот вопрос нет однозначного ответа. Количество потоков, как минимум,
зависит от того на каком компьютере выполняется 
скрипт (ОС, память, процессор), от самой сети (задержек).

Поэтому, вместо поиска идеального количества потоков, надо замерить количество на своем
компьютере, сети, скрипте. Например, в примерах к этому разделу есть скрипт 
netmiko_count_threads.py, который запускает одну и ту же функцию с разным 
количеством потоков и выводит информацию о времени выполнения.
В функции используетс янебольшое количество устройств и небольшое количество потоков,
однако даже на этом примере видно на каком количестве потоков время выполнения 
перестало уменьшатся.

Рассмотрим пример выполнения скрипта netmiko_count_threads.py для 40 устройств, с выводом
информации о времени выполнения.

Первый пример последовательное выполнение одной команды на 40 устройствах:

::

    Количество устройств: 40
    ########## Последовательное выполнение ###########
    0:05:03.249943

Первый тест: от 5 до 30 потоков с шагом 5:

::

    $ python netmiko_threads_submit_count.py
    Количество устройств: 40
    ################### 5 потоков ####################
    0:01:03.416216
    ################### 10 потоков ###################
    0:00:36.339131
    ################### 15 потоков ###################
    0:00:28.748473
    ################### 20 потоков ###################
    0:00:20.728099
    ################### 25 потоков ###################
    0:00:20.889887
    ################### 30 потоков ###################
    0:00:19.441675

Второй тест: от 20 до 40 потоков с шагом 5:

::

    $ python netmiko_threads_submit_count.py
    Количество устройств: 40
    ################### 20 потоков ###################
    0:00:22.222185
    ################### 25 потоков ###################
    0:00:20.248397
    ################### 30 потоков ###################
    0:00:19.714420
    ################### 35 потоков ###################
    0:00:18.888092
    ################### 40 потоков ###################
    0:00:15.560998

В данном случае, можно использовать 40 потоков, так как в этом случае скрипт выполнился
быстрее всего.
Однако, это не значит, что всегда надо использовать столько потоков, сколько устройств.
В целом, при подключении к оборудованию, как правило, количество потоков десятки.

Пример подключения к 5000 устройств с разным количеством потоков:

::

    Количество устройств: 5460

    #30 потоков
    ----------------------------------------
    Время выполнения: 0:09:17.187867

    #50 потоков
    ----------------------------------------
    Время выполнения: 0:09:17.604252

    #70 потоков
    ----------------------------------------
    Время выполнения: 0:09:17.117332

    #90 потоков
    ----------------------------------------
    Время выполнения: 0:09:16.693774

    #100 потоков
    ----------------------------------------
    Время выполнения: 0:09:17.083294

    #120 потоков
    ----------------------------------------
    Время выполнения: 0:09:17.945270

    #140 потоков
    ----------------------------------------
    Время выполнения: 0:09:18.114993

    #200 потоков
    ----------------------------------------
    Время выполнения: 0:11:12.951247

    #300 потоков
    ----------------------------------------
    Время выполнения: 0:14:03.790432

В этом случае время выполнения с 30 потоками и 120 потоков одинаковое, а после время только
увеличивается. 
Так происходит потому что на переключение между потоками также тратится много времени, 
чем больше потоков, тем больше переключений. 
И с какого-то момента нет смысла увеличивать количество потоков. Тут оптимальным количеством можно считать, например, 50 потоков. Тут мы берем не 30 чтобы сделать запас. 

